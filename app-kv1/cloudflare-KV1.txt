Cloudflare KV ã‚’å…±é€šã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦ã€è¤‡æ•°ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨ã§ãã‚‹ **APIï¼ˆKey-Value Storage APIï¼‰** ã‚’ä½œã‚‹å ´åˆã€ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ã¨ä¾¿åˆ©ã§ã™ã€‚

### **è¦ä»¶**
1. **çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ï¼ˆã‚¢ãƒ—ãƒªã”ã¨ã«ç•°ãªã‚‹ãƒ‡ãƒ¼ã‚¿å‹ã§ã‚‚çµ±ä¸€çš„ã«æ‰±ãˆã‚‹ï¼‰
2. **ã‚¢ãƒ—ãƒªã”ã¨ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢**ï¼ˆåå‰ç©ºé–“ãƒ»ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ç®¡ç†ï¼‰
3. **JSON å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»å–å¾—**
4. **åœ§ç¸®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰**
5. **èªè¨¼ï¼ˆAPIã‚­ãƒ¼ or JWTï¼‰**

---

## **1. Cloudflare Workers ã§ API ã‚’æ§‹ç¯‰**
Cloudflare Workers ã‚’ä½¿ã£ã¦ã€Cloudflare KV (ex. store0) ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ API ã‚’ä½œæˆã—ã¾ã™ã€‚

### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆ**
| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | å†…å®¹ |
|----------|--------------|------|
| `POST`   | `/kv/set`    | ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ |
| `GET`    | `/kv/get`    | ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— |
| `DELETE` | `/kv/delete` | ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ |
| `PUT`    | `/kv/set`    | ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° |
| `GET`    | `/kv/list/app0`   | ã‚­ãƒ¼ã®ãƒªã‚¹ãƒˆã‚’å–å¾— |

---


index.js

export default {
	async fetch(req, env) {
		const url = new URL(req.url);
		const { method } = req;

		// CORS Middleware
		const withCors = (res) => {
			res.headers.set('Access-Control-Allow-Origin', '*');
			res.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
			res.headers.set('Access-Control-Allow-Headers', 'Content-Type');
			return res;
		};

		// Preflight req Handling (OPTIONS method)
		if (method === 'OPTIONS') {
			return withCors(new Response(null, { status: 204 }));
		}

		// Handle POST /kv/set
		if (url.pathname === '/kv/set' && method === 'POST') {
			try {
				const { app, key, value } = await req.json();
				if (!app || !key || !value) return withCors(new Response('Missing app, key, or value', { status: 400 }));

				await env.store0.put(`${app}:${key}`, JSON.stringify(value)); // Namespaced Key
				return withCors(new Response(JSON.stringify({ success: true }), { status: 200 }));
			} catch (error) {
				return withCors(new Response(error.toString(), { status: 500 }));
			}
		}

		// Handle GET /kv/get/:app/:key
		if (url.pathname.startsWith('/kv/get/') && method === 'GET') {
			const [, , , app, key] = url.pathname.split('/');
			if (!app || !key) return withCors(new Response('Missing app or key', { status: 400 }));

			const value = await env.store0.get(`${app}:${key}`);
			return value ? withCors(new Response(value)) : withCors(new Response('Not Found', { status: 404 }));
		}

		// Handle DELETE /kv/delete/:app/:key
		if (url.pathname.startsWith('/kv/delete/') && method === 'DELETE') {
			const [, , , app, key] = url.pathname.split('/');
			if (!app || !key) return withCors(new Response('Missing app or key', { status: 400 }));

			await env.store0.delete(`${app}:${key}`);
			return withCors(new Response(JSON.stringify({ success: true }), { status: 200 }));
		}

		// Handle GET /kv/list/:app
		if (url.pathname.startsWith('/kv/list/') && method === 'GET') {
			const [, , , app] = url.pathname.split('/');
			if (!app) return withCors(new Response('Missing app', { status: 400 }));

			const list = await env.store0.list({ prefix: `${app}:` });
			const keys = list.keys.map((k) => k.name.replace(`${app}:`, ''));
			return withCors(new Response(JSON.stringify(keys), { status: 200 }));
		}

		// 404 Not Found
		return withCors(new Response('Not Found', { status: 404 }));
	},
};





APIã®å‹•ä½œç¢ºèª

npx wrangler dev

curl -X GET http://localhost:8787/kv/get/app1/message

curl -X POST http://localhost:8787/kv/set \
  -H "Content-Type: application/json" \
  -d '{"app": "app1", "key": "message1", "value": "Hello from app1-1"}'

curl -X POST http://localhost:8787/kv/set \
  -H "Content-Type: application/json" \
  -d '{"app": "app1", "key": "message2", "value": "Hello from app1-2"}'

curl -X GET http://localhost:8787/kv/get/app1/message1
curl -X GET http://localhost:8787/kv/get/app1/message2

curl -X POST http://localhost:8787/kv/set \
  -H "Content-Type: application/json" \
  -d '{"app": "app2", "key": "message1", "value": "Hello from app2-1"}'

curl -X GET http://localhost:8787/kv/get/app1/message2

curl -X GET http://localhost:8787/kv/list/app1

curl -X PUT http://localhost:8787/kv/set \
  -H "Content-Type: application/json" \
  -d '{"app": "app1", "key": "message1", "value": "Updated message from app1-1"}'

curl -X GET http://localhost:8787/kv/get/app1/message1

curl -X DELETE http://localhost:8787/kv/delete/app1/message2

curl http://localhost:8787/kv/get/app1/message2

curl -X GET http://localhost:8787/kv/list/app1


npx wranger deploy


---


### **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ Cloudflare Workers API ã‚’ä½¿ã†æ–¹æ³•**  
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® JavaScript ã‹ã‚‰ API ã‚’ä½¿ã£ã¦ Cloudflare KV ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»å–å¾—ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

---

## **ğŸ“Œ 1. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä»•æ§˜**
ã¾ãšã€Cloudflare Workers API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç¢ºèªã—ã¾ã™ã€‚

| **HTTP ãƒ¡ã‚½ãƒƒãƒ‰** | **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**       | **èª¬æ˜** |
|-----------------|--------------------|------------|
| `POST`         | `/kv/set`           | ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»æ›´æ–° |
| `GET`          | `/kv/get/{app}/{key}` | ãƒ‡ãƒ¼ã‚¿ã®å–å¾— |
| `DELETE`       | `/kv/delete/{app}/{key}` | ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ |
| `GET`          | `/kv/list/{app}`    | ã‚¢ãƒ—ãƒªã”ã¨ã®ã‚­ãƒ¼ä¸€è¦§å–å¾— |

> **API ã®ãƒ™ãƒ¼ã‚¹ URL**
> - **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ:** `http://localhost:8787`
> - **ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ:** `https://your-cloudflare-worker-url.com`

---

## **ğŸ“Œ 2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã® JavaScript ã‚³ãƒ¼ãƒ‰**
ä»¥ä¸‹ã® JavaScript é–¢æ•°ã‚’ä½¿ã£ã¦ API ã‚’å‘¼ã³å‡ºã›ã¾ã™ã€‚

### **ğŸ”¹ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜**
```javascript
async function saveData(app, key, value) {
    const response = await fetch("http://localhost:8787/kv/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ app, key, value })
    });
    return response.json();
}

// ä¾‹: "app1" ã® "message" ã‚­ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
saveData("app1", "message", "Hello, Cloudflare!").then(console.log);
```

âœ… **æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{"success": true}
```

---

### **ğŸ”¹ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—**
```javascript
async function getData(app, key) {
    const response = await fetch(`http://localhost:8787/kv/get/${app}/${key}`);
    if (!response.ok) throw new Error("Data not found");
    return response.text();
}

// ä¾‹: "app1" ã® "message" ã‚’å–å¾—
getData("app1", "message").then(console.log).catch(console.error);
```

âœ… **æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
"Hello, Cloudflare!"
```

---

### **ğŸ”¹ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°**
ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (`/kv/set`) ã¨åŒã˜ API ã‚’ä½¿ã†ã®ã§ã€`saveData()` ã‚’å‘¼ã³å‡ºã›ã° OKã€‚

```javascript
saveData("app1", "message", "Updated message").then(console.log);
```

âœ… **æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{"success": true}
```

---

### **ğŸ”¹ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤**
```javascript
async function deleteData(app, key) {
    const response = await fetch(`http://localhost:8787/kv/delete/${app}/${key}`, {
        method: "DELETE"
    });
    return response.json();
}

// ä¾‹: "app1" ã® "message" ã‚’å‰Šé™¤
deleteData("app1", "message").then(console.log);
```

âœ… **æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{"success": true}
```

---

### **ğŸ”¹ ã‚¢ãƒ—ãƒªã”ã¨ã®ã‚­ãƒ¼ä¸€è¦§ã‚’å–å¾—**
```javascript
async function listKeys(app) {
    const response = await fetch(`http://localhost:8787/kv/list/${app}`);
    return response.json();
}

// ä¾‹: "app1" ã®ã‚­ãƒ¼ä¸€è¦§ã‚’å–å¾—
listKeys("app1").then(console.log);
```

âœ… **æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
["message", "anotherKey"]
```

---

## **ğŸ“Œ 3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã®çµ„ã¿è¾¼ã¿ä¾‹**
ä¾‹ãˆã°ã€HTML ã®ãƒ•ã‚©ãƒ¼ãƒ ã¨é€£æºã—ã¦ API ã‚’ä½¿ã†ä¾‹:

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare KV API Demo</title>
</head>
<body>
    <h1>Cloudflare KV API Demo</h1>

    <input type="text" id="key" placeholder="Key">
    <input type="text" id="value" placeholder="Value">
    <button onclick="save()">Save</button>
    <button onclick="load()">Load</button>

    <p id="result"></p>

    <script>
        const app = "app1"; // å›ºå®šã®ã‚¢ãƒ—ãƒªå

        async function save() {
            const key = document.getElementById("key").value;
            const value = document.getElementById("value").value;
            const res = await saveData(app, key, value);
            document.getElementById("result").innerText = JSON.stringify(res);
        }

        async function load() {
            const key = document.getElementById("key").value;
            try {
                const value = await getData(app, key);
                document.getElementById("result").innerText = value;
            } catch (e) {
                document.getElementById("result").innerText = "Not Found";
            }
        }
    </script>
</body>
</html>
```


| **æ“ä½œ** | **é–¢æ•°** | **API** |
|---------|---------|--------|
| ãƒ‡ãƒ¼ã‚¿ä¿å­˜ | `saveData(app, key, value)` | `POST /kv/set` |
| ãƒ‡ãƒ¼ã‚¿å–å¾— | `getData(app, key)` | `GET /kv/get/{app}/{key}` |
| ãƒ‡ãƒ¼ã‚¿æ›´æ–° | `saveData(app, key, value)` | `POST /kv/set` |
| ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ | `deleteData(app, key)` | `DELETE /kv/delete/{app}/{key}` |
| ã‚­ãƒ¼ä¸€è¦§å–å¾— | `listKeys(app)` | `GET /kv/list/{app}` |

---






`pako` ã¯ zlib ã®åœ§ç¸®ãƒ»è§£å‡ã‚’è¡Œã† JavaScript ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚Cloudflare Workers ã§ã‚‚ `gzip`/`ungzip` ã‚’æ‰±ã†ã®ã«ä¾¿åˆ©ã§ã™ã€‚  

## **`pako` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
ã‚‚ã—ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ä½¿ã†å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```sh
npm install pako
```

## **gzip åœ§ç¸®ã—ã¦ Cloudflare KV ã«ä¿å­˜**
Cloudflare KV ã¯ **æœ€å¤§25MBã®ãƒ‡ãƒ¼ã‚¿** ã‚’ä¿å­˜ã§ãã‚‹ãŸã‚ã€å¤§ããª JSON ãƒ‡ãƒ¼ã‚¿ãªã©ã‚’åœ§ç¸®ã™ã‚‹ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨è»¢é€é‡ã‚’ç¯€ç´„ã§ãã¾ã™ã€‚

```javascript
import { gzip } from 'pako';

const data = { type: "log", messages: ["ãƒ­ã‚°1", "ãƒ­ã‚°2", "ãƒ­ã‚°3"] };
const compressed = gzip(JSON.stringify(data));

// Cloudflare KV ã«ä¿å­˜
await env.KV_NAMESPACE.put("logs:001", compressed, { expirationTtl: 86400 });
```

`expirationTtl: 86400` ã¯ **24æ™‚é–“å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å‰Šé™¤** ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ï¼ˆä¸è¦ãªã‚‰çœç•¥ï¼‰ã€‚

---

## **Cloudflare KV ã‹ã‚‰å–ã‚Šå‡ºã—ã¦è§£å‡**
ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã€è§£å‡ã—ã¦å…ƒã® JSON ã«æˆ»ã—ã¾ã™ã€‚

```javascript
import { ungzip } from 'pako';

const compressedData = await env.KV_NAMESPACE.get("logs:001", { type: "arrayBuffer" });

if (compressedData) {
  const decompressed = JSON.parse(new TextDecoder().decode(ungzip(new Uint8Array(compressedData))));
  console.log(decompressed);  // { type: "log", messages: ["ãƒ­ã‚°1", "ãƒ­ã‚°2", "ãƒ­ã‚°3"] }
}
```

---

## **ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ã«æ³¨æ„**
Cloudflare KV ã® `put` ã¯ **æ–‡å­—åˆ—ï¼ˆstringï¼‰** ã§ä¿å­˜ã™ã‚‹ã®ãŒåŸºæœ¬ã§ã™ãŒã€`Uint8Array` ã‚„ `ArrayBuffer` ã‚‚ä¿å­˜å¯èƒ½ã§ã™ã€‚ãã®å ´åˆã€`get` æ™‚ã« `{ type: "arrayBuffer" }` ã‚’æŒ‡å®šã—ãªã„ã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒæ–‡å­—åˆ—ã¨ã—ã¦ç ´æã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### **ãƒã‚¤ãƒŠãƒªã‚’ Base64 ã«å¤‰æ›ã—ã¦ä¿å­˜ã™ã‚‹æ–¹æ³•**
ã‚‚ã— `arrayBuffer` ã‚’ä½¿ã„ãŸããªã„å ´åˆã¯ã€Base64 å¤‰æ›ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚

```javascript
import { gzip } from 'pako';

// Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
function encodeBase64(bytes) {
  return btoa(String.fromCharCode(...bytes));
}

// Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
function decodeBase64(str) {
  return new Uint8Array([...atob(str)].map(c => c.charCodeAt(0)));
}

// ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ã—ã¦ Base64 ã«å¤‰æ›
const compressedBase64 = encodeBase64(gzip(JSON.stringify(data)));

// KV ã«ä¿å­˜
await env.KV_NAMESPACE.put("logs:001", compressedBase64);
```

### **å–å¾—æ™‚ã«è§£å‡**
```javascript
import { ungzip } from 'pako';

const compressedBase64 = await env.KV_NAMESPACE.get("logs:001");

if (compressedBase64) {
  const decompressed = JSON.parse(new TextDecoder().decode(ungzip(decodeBase64(compressedBase64))));
  console.log(decompressed);
}
```

---

## **ã©ã®æ–¹æ³•ã‚’é¸ã¶ã¹ãã‹ï¼Ÿ**
| æ–¹æ³• | é•·æ‰€ | çŸ­æ‰€ |
|------|------|------|
| **é€šå¸¸ã® JSON æ–‡å­—åˆ—** | ãã®ã¾ã¾ä¿å­˜ã§ãã‚‹ | å¤§ããªãƒ‡ãƒ¼ã‚¿ã¯ã‚µã‚¤ã‚ºå¢—åŠ  |
| **gzip åœ§ç¸® + ArrayBuffer** | ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’å¤§å¹…å‰Šæ¸› | `arrayBuffer` æŒ‡å®šãŒå¿…è¦ |
| **gzip åœ§ç¸® + Base64** | `arrayBuffer` ã‚’ä½¿ã‚ãªãã¦æ¸ˆã‚€ | Base64å¤‰æ›ã§å°‘ã—ã‚µã‚¤ã‚ºå¢—åŠ  |

åœ§ç¸®ã—ã¦ä¿å­˜ã™ã‚‹ãªã‚‰ã€åŸºæœ¬ã¯ `gzip + ArrayBuffer` ã§ OK ã§ã™ã€‚Base64 ã¯ JSON ã®ã¿ã‚’æ‰±ã†å ´åˆã«ä¾¿åˆ©ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã¯å°‘ã—å¢—ãˆã¾ã™ã€‚

Cloudflare KV ã«å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãªã‚‰ã€**gzip åœ§ç¸®ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚³ã‚¹ãƒˆã‚’æ”¹å–„** ã§ãã¾ã™ï¼ ğŸš€
